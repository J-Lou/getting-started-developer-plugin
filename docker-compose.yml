# Copyright (c) 2018 CA. All rights reserved.
# This software may be modified and distributed under the terms
# of the MIT license.  See the LICENSE file for details.

version: '3.4'
services:
  gateway-dev:
    hostname: localhost
    image: caapim/gateway:latest
    ports:
    - "808:8080"
    - "844:8443"
    - "800:8000"
    volumes:
    - /opt/SecureSpan/Gateway/node/default/etc/bootstrap/services/restman
    - ./deployment/build/gateway/deployment-1.0.0.gw7:/opt/docker/rc.d/deployment.gw7
    secrets:
    - source: license
      target: /opt/SecureSpan/Gateway/node/default/etc/bootstrap/license/license.xml
    environment:
      ACCEPT_LICENSE: "true"
      SSG_ADMIN_USERNAME: "admin"
      SSG_ADMIN_PASSWORD: "password"
      ENV.CONTEXT_VARIABLE_PROPERTY.BackgroundEnvironmentService.color: "blue"
      ENV.JDBC_CONNECTION.Mysql: |-
              driverClass: com.mysql.jdbc.Driver
              jdbcUrl: jdbc:mysql://mysql-server:3306
              user: test
              password: password
              minimumPoolSize: 3
              maximumPoolSize: 15
              properties:
                EnableCancelTimeout: 'true'
    depends_on:
        - mysql-server

  mysql-server:
    build:
      context: .
      dockerfile: Dockerfile-mysql
    image: test_mysql:latest
    ports:
      - "3306"
    command:
      - "--character-set-server=utf8"
      - "--innodb_log_buffer_size=32M"
      - "--innodb_log_file_size=80M"
      - "--max_allowed_packet=8M"

secrets:
  license:
    file: ./docker/license.xml
